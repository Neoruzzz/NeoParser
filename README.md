# OLX.KZ Neoparser Telegram Bot

Этот репозиторий содержит Telegram-бота для парсинга объявлений с сайта [OLX.KZ](https://www.olx.kz). Бот ищет объявления по заданным параметрам, фильтрует их и отправляет результаты непосредственно в Telegram.

---

## Особенности

- **Парсинг объявлений:** Получение информации о товарах, их цене, местоположении, просмотрах и прочей детализации.
- **Детальный разбор:** Дополнительный сбор данных о профиле продавца (рейтинг, количество объявлений, дата регистрации и т.д.).
- **Логирование:** Ведение логов с записью каждого действия парсера, сохранение логов в сжатых tar.gz файлах.
- **Управление на удалённом сервере:** Возможность загрузки, запуска, остановки и обновления бота через SSH с использованием `tmux`.
- **Пресеты параметров:** Возможность сохранения и использования набора параметров для парсинга.

---

## Структура репозитория

- **main.py**  
  Основной скрипт бота, который:
  - Обрабатывает команды Telegram (например, `/start`, `/parse`, `/preset`, `/stop`, `/broadcast`)
  - Выполняет парсинг списка объявлений и детальную обработку каждого объявления и профиля продавца
  - Логирует действия и отправляет лог-файл пользователю по завершении парсинга

- **panel.py**  
  Скрипт для управления ботом на удалённом сервере. Предоставляет следующие возможности:
  - **install:** Загрузка файлов бота (например, `main.py` и `allowed.txt`) на сервер
  - **start:** Запуск бота в отдельной `tmux` сессии
  - **stop:** Остановка запущенного бота (завершение `tmux` сессии)
  - **pkg:** Установка нового пакета через `pip` на сервере

- **pkg.bat**  
  Батник, который запрашивает название пакета, а затем запускает `panel.py` для установки указанного пакета.

- **start.bat**  
  Батник для запуска бота через `panel.py`.

- **stop.bat**  
  Батник для остановки бота через `panel.py`.

- **update.bat**  
  Батник для обновления бота: останавливает текущую сессию, загружает обновлённые файлы и запускает бота заново.

---

## Установка и настройка

### 1. Клонирование репозитория

```bash
git clone <URL_репозитория>
cd <имя_репозитория>
```

### 2. Установка зависимостей

Убедитесь, что у вас установлен Python версии 3.7 или выше. Установите необходимые пакеты:

```bash
pip install -r requirements.txt
```

Если файла `requirements.txt` нет, установите следующие зависимости:

- `python-telegram-bot`
- `aiohttp`
- `aiofiles`
- `beautifulsoup4`
- `python-dotenv`
- `paramiko`

### 3. Настройка переменных окружения

Создайте файл `.env` в корневой директории и добавьте следующие переменные:

```env
TOKEN=<ваш Telegram Bot Token>
HOST=<хост для SSH подключения>
USERNAME=<имя пользователя SSH>
PASSWORD=<пароль SSH>
```

Также создайте файл `allowed.txt`, в котором укажите user_id (один на строке) пользователей, которым разрешён доступ к боту.

### 4. Запуск бота локально

Для локального запуска бота выполните:

```bash
python main.py
```

---

## Управление ботом на сервере

Скрипт `panel.py` позволяет управлять ботом на удалённом сервере через SSH.

### Доступные команды

- **Загрузка файлов бота:**

  ```bash
  python panel.py install
  ```

- **Запуск бота:**

  ```bash
  python panel.py start
  ```

- **Остановка бота:**

  ```bash
  python panel.py stop
  ```

- **Установка пакета через pip:**

  ```bash
  python panel.py pkg -p <название_пакета>
  ```

### Использование BAT файлов

Для удобства предусмотрены следующие батники:

- **pkg.bat:** Запрашивает название пакета и устанавливает его на сервере.
- **start.bat:** Запускает бота через `panel.py`.
- **stop.bat:** Останавливает бота через `panel.py`.
- **update.bat:** Останавливает бота, загружает обновления и запускает бота заново.

Просто запустите соответствующий `.bat` файл двойным кликом в Windows.

---

## Использование Telegram бота

После запуска бота, пользователи могут взаимодействовать с ним через следующие команды:

- **/start**  
  Отправляет инструкции по использованию и список сохранённых пресетов.

- **/parse**  
  Запускает парсинг объявлений с параметрами:
  ```
  /parse (Количество страниц) (Минимальная цена) (Максимальная цена) (Максимальное количество просмотров) (Максимальное количество объявлений) (Минимальная дата регистрации (год)) (Максимальный рейтинг)
  ```
  Также поддерживается запуск по пресету:
  ```
  /parse preset (Название пресета)
  ```

- **/preset**  
  Добавляет новый пресет с заданными параметрами:
  ```
  /preset (Название) (Количество страниц) (Минимальная цена) (Максимальная цена) (Максимальное количество просмотров) (Максимальное количество объявлений) (Минимальная дата регистрации (год)) (Максимальный рейтинг)
  ```

- **/stop**  
  Останавливает запущенный парсинг.

- **/broadcast**  
  (Только для администраторов) Рассылка сообщений всем пользователям, имеющим доступ к парсеру.

После завершения парсинга бот отправляет лог-файл, содержащий подробную информацию о выполненных действиях.

---

## Примечания

- **API OLX.KZ:** К сожалению, у API olx.kz есть рейтлимиты на получение телефона юзера, так что вы можете прибегнуть к внедрению прокси или обхода через вебэмуляцию.
- **tmux:** Для управления сессиями на сервере используется `tmux`. Убедитесь, что он установлен на удалённом сервере.
- **Безопасность:** Файл `allowed.txt` определяет, кто имеет доступ к функционалу парсера. Обновляйте его по мере необходимости.
- **Администрация бота:** Не забудьте поменять ID администрации бота в main.py 

---

## Автор

olx.kz neoparser by [@sv1zx](https://t.me/sv1zx)

